"use strict";function ExtendedBrush(e){0===arguments.length?go.Brush.call(this):go.Brush.call(this,e)}go.Diagram.inherit(ExtendedBrush,go.Brush),ExtendedBrush.parse=ExtendedBrush.parse=function(e,r,t){if(-1!==e.indexOf("linear"))return ExtendedBrush._parseLinearGradientCSS(e,r,t);if(-1!==e.indexOf("radial"))return ExtendedBrush._parseRadialGradientCSS(e,r,t);if(go.Brush.isValidColor(e)){var n=new go.Brush(go.Brush.Solid);return n.color=e,n}var n=new go.Brush(go.Brush.Pattern),o=document.createElement("img");return o.src=e,n.pattern=o,n},ExtendedBrush.stringify=ExtendedBrush.stringify=function(e){if(!(e instanceof go.Brush))throw new Error("ExtendedBrush.stringify requires a Brush argument, not: "+e);var r="";if(e.type===go.Brush.Solid)return e.color;if(e.type===go.Brush.Linear){r="linear-gradient(";var t=ExtendedBrush._angleBetweenSpots(e);isNaN(t)&&(t=180),r+=t+"deg",r+=ExtendedBrush._convertStopsToCSS(e),r+=")"}else e.type===go.Brush.Radial?(r="radial-gradient(",e.endRadius&&(r+=Math.round(e.endRadius)+"px "),e.ellipseHeight&&(r+=Math.round(e.ellipseHeight)+"px "),r+="at ",r+=100*e.start.x+"% ",r+=100*e.start.y+"% ",r+=ExtendedBrush._convertStopsToCSS(e),r+=")"):e.type===go.Brush.Pattern&&e.pattern&&(r=e.pattern.getAttribute("src"));return r},ExtendedBrush._convertStopsToCSS=function(e){for(var r=e.colorStops.iterator,t="";r.next();)t+=", "+r.value+" "+100*r.key+"%";return t},ExtendedBrush._UNITS=["px","pt","pc","in","cm","mm"],ExtendedBrush._lengthToPX=function(e,r){var t=96,n=2.54;switch(r){case"px":return e;case"pt":return 3*e/4;case"pc":return 9*e;case"in":return e*t;case"cm":return e*t/n;case"mm":return e*t/(10*n);default:return NaN}},ExtendedBrush._pxToPercent=function(e,r,t,n){return(n=parseFloat(n))%180==0?e/r:(n*=Math.PI/180,e/(Math.abs(t*Math.sin(n))+Math.abs(r*Math.cos(n))))},ExtendedBrush._parseLinearGradientCSS=function(e,r,t){var n=e.match(/\((.*)\)/g);if(null===n)throw new Error("Invalid CSS Linear Gradient: "+e);n=n[0],n=n.substring(1,n.length-1),n=n.split(/,(?![^\(]*\))/g),n[0]=n[0].trim(),go.Brush.isValidColor(n[0].split(/\s(?![^\(]*\))/g)[0])&&n.splice(0,0,"180deg"),n[0]=ExtendedBrush._linearGradientAngleToDegrees(n[0],r,t);var o=parseFloat(n[0])+180,a=ExtendedBrush._createColorStopArray(n),d=new go.Brush(go.Brush.Linear),s=ExtendedBrush._calculateLinearGradientSpots(o,r,t);d.start=s[0],d.end=s[1];for(var i=0;i<a.length;i++)d.addColorStop(a[i].position,a[i].color);return d},ExtendedBrush._createColorStopArray=function(e){for(var r=[],t=1;t<e.length;t++){e[t]=e[t].trim();var n=e[t].split(/\s+(?![^\(]*\))/g),o={};if(!go.Brush.isValidColor(n[0]))throw new Error("Invalid CSS Color in Linear Gradient: "+n[0]+" in "+e);if(n[1]!==undefined){var a=n[1].match(/[^\d.]+/g)[0];if(-1!==ExtendedBrush._UNITS.indexOf(a)){n[1]=parseFloat(n[1]);var d=ExtendedBrush._lengthToPX(n[1],a);o.position=ExtendedBrush._pxToPercent(d,w,h,angle)}else{if("%"!==a)throw new Error("Invalid Linear Gradient Unit: "+a+" in "+e);o.position=parseFloat(n[1])/100}}else o.position=NaN;o.color=n[0],r[t-1]=o}return isNaN(r[0].position)&&(r[0].position=0),isNaN(r[r.length-1].position)&&(r[r.length-1].position=1),ExtendedBrush._fixLinearGradientPositions(r),r},ExtendedBrush._fixLinearGradientPositions=function(e,r,t){for(r===undefined&&(r=0),t===undefined&&(t=e.length);r<t-1&&!isNaN(e[r+1].position);)r++;if(r!==t-1){for(var n=r+1;n<t&&isNaN(e[n].position);)n++;for(var o=(e[n].position-e[r].position)/(n-r),a=1;a<n-r;a++)e[a+r].position=Math.round(1e3*(e[r].position+a*o))/1e3;n<t-1&&ExtendedBrush._fixLinearGradientPositions(e,n,t)}},ExtendedBrush._calculateLinearGradientSpots=function(e,r,t){if(e=parseFloat(e),90===(e=(e%360+360)%360))return[new go.Spot(0,0,r,t/2),new go.Spot(0,0,0,t/2)];if(270===e)return[new go.Spot(0,0,0,t/2),new go.Spot(0,0,r,t/2)];var n=90-Math.abs(e%180-90),o=Math.tan(n*Math.PI/180),a=.5*(t*o-r)/(o*o+1),d=a*o;return e>=90&&e<=270&&(d=t-d),a=e<180?r+a:-a,[new go.Spot(0,0,a,d),new go.Spot(0,0,r-a,t-d)]},ExtendedBrush._applyLinearGradientSpots=function(e,r,t,n){var o=ExtendedBrush._calculateLinearGradientSpots(e,r,t);return n.start=o[0],n.end=o[1],n},ExtendedBrush._linearGradientAngleToDegrees=function(e,r,t){var n=e.indexOf("to ")<0,o=e.match(/\d/g),a=e.match(/0/g);if(null!==a&&o.length===a.length)return 0;if(!n){var d=0;e.indexOf("right")>=0?d=90:e.indexOf("left")>=0&&(d=-90);var s=0===d?0:d>0?1:-1;if(e.indexOf("top")>=0?d-=s*Math.atan(r/t)*180/Math.PI:e.indexOf("bottom")>=0&&(0===d?d=180:d+=s*Math.atan(r/t)*180/Math.PI),0===d&&e.indexOf("top")<0)throw new Error("Invalid CSS Linear Gradient direction: "+e);return Math.round(d)}switch(e=e.match(/[^a-z]+|\D+/g),e[1]){case"deg":return e[0];case"rad":return 180*e[0]/Math.PI;case"turn":return 360*e[0];case"grad":return 9*e[0]/10;default:throw new Error("Invalid CSS Linear Gradient direction: "+e[1])}},ExtendedBrush._angleBetweenSpots=function(e){var r=e.start,t=e.end;if(isNaN(r.x+r.y+t.x+t.y))throw new Error("The brush does not have valid spots");var n=(t.offsetX,r.offsetX,r.offsetY,t.offsetY,180*Math.atan((r.offsetX-t.offsetX)/(t.offsetY-r.offsetY))/Math.PI);return r.offsetY>t.offsetY&&(n+=180),(n+360)%360},ExtendedBrush._parseRadialGradientCSS=function(e,r,t){if(null===(e=e.match(/\((.*)\)/g)))throw new Error("Invalid CSS Linear Gradient");e=e[0],e=e.substring(1,e.length-1),e=e.split(/,(?![^\(]*\))/g),e[0]=e[0].trim();var n=go.Brush.isValidColor(e[0].split(" ")[0]),o=[r/2,t/2],a=new go.Spot(.5,.5,0,0);if(!n){var d=e[0];if(d=d.split("at"),1===d.length)a=new go.Spot(.5,.5,0,0);else{if(2!==d.length)throw new Error("invalid css radial gradient string");a=ExtendedBrush._parseCenter(d[1],r,t)}o=ExtendedBrush._parseShapeDescription(d[0],r,t,a)}var s=ExtendedBrush._createColorStopArray(e),i=new go.Brush(go.Brush.Radial);i.start=a,i.end=a,i.startRadius=0,i.endRadius=o[0],i.ellipseHeight=o[1];for(var h=0;h<s.length;h++)i.addColorStop(s[h].position,s[h].color);return i},ExtendedBrush._parseCenter=function(e,r,t){var n=[];e=e.trim();var o=e.split(/\s+/g);if(1===o.length)n=ExtendedBrush._englishPositionToCoordinate(o[0]);else if(2===o.length){var a=e.match(/\d+/g);if(null===a)n=ExtendedBrush._englishPositionToCoordinate(e);else if(1===a.length){var d,s;null===o[0].match(/\d+/g)?(s=o[0],d=o[1]):(s=o[1],d=o[0]),d=ExtendedBrush._parseLengthToPercent(d),n=ExtendedBrush._englishPositionToCoordinate(s),n[1]=d}else 2===a.length&&(n[0]=ExtendedBrush._parseLengthToPercent(o[0],r),n[1]=ExtendedBrush._parseLengthToPercent(o[1],t))}else if(3===o.length);else{if(4!==o.length)throw new Error("invalid CSS position description");switch(o[0]){case"right":n[0]=1-ExtendedBrush._parseLengthToPercent(n[1],r);case"left":n[0]=ExtendedBrush._parseLengthToPercent(n[1],r);default:throw new Error("invalid location keyword: "+o[0])}switch(o[2]){case"top":n[0]=ExtendedBrush._parseLengthToPercent(n[3],t);case"bottom":n[0]=1-ExtendedBrush._parseLengthToPercent(n[3],t);default:throw new Error("invalid location keyword: "+o[2])}}return new go.Spot(n[0],n[1],0,0)},ExtendedBrush._parseLengthToPercent=function(e,r){return e.indexOf("%")<0?ExtendedBrush._parseLengthToPX(e)/r:parseFloat(e)/100},ExtendedBrush._parseLengthToPX=function(e){var r=parseFloat(e.match(/\d+/g)[0]),t=e.match(/\D+/g)[0];return ExtendedBrush._lengthToPX(r,t)},ExtendedBrush._englishPositionToCoordinate=function(e){var r=.5,t=.5;return e.indexOf("bottom")>-1?t=1:e.indexOf("top")>-1&&(t=0),e.indexOf("left")>-1?r=0:e.indexOf("right")>-1&&(r=1),[r,t]},ExtendedBrush._parseShapeDescription=function(e,r,t,n){var o=n.x,a=n.y;e=e.trim();var d=e.split(" ");if(null===d)return[r/2,t/2];if(1===d.length){var s=Math.abs(r/2-o*r)+r/2,i=Math.abs(t/2-a*t)+t/2;if(e.indexOf("ellipse")>-1)return[s*Math.sqrt(2),i*Math.sqrt(2)];if(e.indexOf("circle")>-1){var h=Math.sqrt(s*s+i*i);return[h,h]}return ExtendedBrush._parseExtentKeyword(e,r,t,n)}if(2===d.length){var u=e.match(/\d+/g);if(null===u)return ExtendedBrush._parseExtentKeyword(e,r,t,n);if(1===u.length){if(d[0].indexOf("circle")>-1&&d[1].indexOf("%")<0){var h=ExtendedBrush._parseLengthToPX(d[1]);return[h,h]}throw new Error("Invalid CSS shape description")}if(2===u.length)return[ExtendedBrush._parseLengthToPX(d[0]),ExtendedBrush._parseLengthToPX(d[1])];throw new Error("Invalid CSS shape description")}if(3===d.length){if("ellipse"!==d[0])throw new Error("invalid CSS shape description");return[ExtendedBrush._parseLengthToPercent(d[1],r)*r,ExtendedBrush._parseLengthToPercent(d[2],t)*t]}throw new Error("invalid CSS shape description")},ExtendedBrush._parseExtentKeyword=function(e,r,t,n){if(!e)return[r/2,t/2];var o,a=n.x,d=n.y,s=Math.abs(r/2-a*r)+r/2,i=Math.abs(t/2-d*t)+t/2,h=e.split(" ");if(null===h)throw new Error("invalid extent keyword");if(o=h[h.length-1],e.indexOf("circle")>-1){switch(o){case"closest-corner":var u=Math.sqrt((r-s)*(r-s)+(t-i)*(t-i));break;case"farthest-corner":var u=Math.sqrt(s*s+i*i);break;case"closest-side":var u=Math.min(r-s,t-i);break;case"farthest-side":var u=Math.max(s,i);break;default:throw new Error("invalid extent keyword: "+o)}return[u,u]}switch(o){case"closest-corner":return[(r-s)*Math.sqrt(2),(t-i)*Math.sqrt(2)];case"farthest-corner":return[s*Math.sqrt(2),i*Math.sqrt(2)];case"closest-side":return[r-s,t-i];case"farthest-side":return[s,i];default:throw new Error("invalid extent keyword: "+o)}},ExtendedBrush._makePaletteFromOneColor=function(e,r){for(var t=ExtendedBrush._RGB_to_Lab(ExtendedBrush.CSSStringToRGB(e)),n=[],o=100/(r+2),a=Math.floor(t[0]/o)-1,d=1;d<=r;d++)n[d-1]=go.Brush.lightenBy(e,o*(d-a)/100);return n},ExtendedBrush._makePaletteFromTwoColors=function(e,r,t){e=ExtendedBrush._RGB_to_Lab(ExtendedBrush.CSSStringToRGB(e)),r=ExtendedBrush._RGB_to_Lab(ExtendedBrush.CSSStringToRGB(r));for(var n=[],o=(ExtendedBrush._MAX_Lab_A,ExtendedBrush._MIN_Lab_A,ExtendedBrush._MAX_Lab_B,ExtendedBrush._MIN_Lab_B,t-1),a=(e[1]-r[1])/o,d=(e[2]-r[2])/o,s=(e[0]-r[0])/o,i=0;i<t;i++){var h=ExtendedBrush._Lab_to_RGB([r[0]+i*s,r[1]+i*a,r[2]+i*d]),u=ExtendedBrush._RGBArrayToCSS(h);n[i]=u}return n},ExtendedBrush.makeColorPalette=ExtendedBrush.makeColorPalette=function(e,r,t){if(arguments.length<1)throw new Error("Please provide at least one color, and at most two color and a number");if(arguments.length>3)throw new Error("Please provide no more than two colors, and an optional number argument");var n=3;if("string"!=typeof e)throw new Error(e+" is not a string");var o=t===undefined,a=function(e){if("number"!=typeof e||isNaN(e)||e===Infinity||e<1)throw new Error("Please provide a number greater than or equal to one, not: "+e)};if(1===arguments.length)return ExtendedBrush._makePaletteFromOneColor(e,n);if("string"==typeof r)return o?ExtendedBrush._makePaletteFromTwoColors(e,r,n):(a(t),ExtendedBrush._makePaletteFromTwoColors(e,r,t));if("number"==typeof r){if(o){if(t=r,a(t),1===t){e=ExtendedBrush.CSSStringToRGB(e),e.splice(3,1);return[ExtendedBrush._RGBArrayToCSS(e)]}return ExtendedBrush._makePaletteFromOneColor(e,t)}throw new Error("Please provide only only one number")}throw new Error("Please provide either a color string or a number")},ExtendedBrush._sharedTempCtx=null,ExtendedBrush.CSSStringToRGB=function(e){if(!go.Brush.isValidColor(e))throw new Error("Invalid CSS Color String: "+e);var r=ExtendedBrush._sharedTempCtx;null===r&&(r=ExtendedBrush._sharedTempCtx=document.createElement("canvas").getContext("2d")),r.clearRect(0,0,1,1),r.fillStyle=e,r.fillRect(0,0,1,1);for(var t=r.getImageData(0,0,1,1).data,n=[],o=0;o<t.length;o++)n.push(t[o]);return n},ExtendedBrush._RGBArrayToCSS=function(e){if(3===e.length)var r="rgb(";else{if(4!==e.length)throw new Error("invalid RGB or RGBa array: "+e);var r="rgba("}for(var t=0;t<e.length;t++)r+=e[t]+(t!==e.length-1?", ":"");return r+")"},ExtendedBrush._MIN_Lab_A=-93,ExtendedBrush._MAX_Lab_A=92,ExtendedBrush._MIN_Lab_B=-114,ExtendedBrush._MAX_Lab_B=92,ExtendedBrush._RGB_to_Lab=function(e){return ExtendedBrush._XYZtoLab(ExtendedBrush._RGBtoXYZ(e))},ExtendedBrush._Lab_to_RGB=function(e){return ExtendedBrush._XYZtoRGB(ExtendedBrush._LabtoXYZ(e))},ExtendedBrush._sRGBtoXYZMatrix=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],ExtendedBrush._XYZtosRGBMatrix=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],ExtendedBrush._rowMultiplication=function(e,r){for(var t=0,n=0;n<r.length;n++)t+=e[n]*r[n];return t},ExtendedBrush._RGB_XYZ_Inverse_Companding=function(e){return e/=255,e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)},ExtendedBrush._XYZ_RGB_Companding=function(e){return 12.92*e<=.04045?12.92*e:1.055*Math.pow(e,.416667)-.055},ExtendedBrush._RGBtoXYZ=function(e){e.splice(3,1);var r,t=[];for(r=0;r<e.length;r++)e[r]=ExtendedBrush._RGB_XYZ_Inverse_Companding(e[r]);for(r=0;r<e.length;r++)t[r]=ExtendedBrush._rowMultiplication(ExtendedBrush._sRGBtoXYZMatrix[r],e);return t},ExtendedBrush._XYZtoRGB=function(e){var r,t=[];for(r=0;r<e.length;r++)t[r]=ExtendedBrush._rowMultiplication(ExtendedBrush._XYZtosRGBMatrix[r],e);for(r=0;r<e.length;r++)t[r]=255*ExtendedBrush._XYZ_RGB_Companding(t[r]),t[r]<0&&(t[r]=0),t[r]*=100,t[r]=Math.round(t[r]),t[r]/=100,t[r]=Math.floor(t[r]),t[r]>255&&(t[r]=255),t[r]<0&&(t[r]=0);return t},ExtendedBrush._Lab_EPSILON=216/24389,ExtendedBrush._Lab_KAPPA=24389/27,ExtendedBrush._XYZ_Lab_HelperFunction=function(e){return e>ExtendedBrush._Lab_EPSILON?Math.pow(e,1/3):(ExtendedBrush._Lab_KAPPA*e+16)/116},ExtendedBrush._XYZtoLab=function(e){var r=[],t=ExtendedBrush._XYZ_Lab_HelperFunction(e[1]);return r[0]=116*t-16,r[1]=500*(ExtendedBrush._XYZ_Lab_HelperFunction(e[0])-t),r[2]=200*(t-ExtendedBrush._XYZ_Lab_HelperFunction(e[2])),r},ExtendedBrush._Lab_XYZ_HelperFunction=function(e){var r=e*e*e;return r>ExtendedBrush._Lab_EPSILON?r:(116*e-16)/ExtendedBrush._Lab_KAPPA},ExtendedBrush._LabtoXYZ=function(e){var r=[];r[1]=(e[0]+16)/116,r[0]=e[1]/500+r[1],r[2]=-e[2]/200+r[1];var t=[];return t[1]=ExtendedBrush._Lab_XYZ_HelperFunction(r[1]),t[0]=ExtendedBrush._Lab_XYZ_HelperFunction(r[0]),t[2]=ExtendedBrush._Lab_XYZ_HelperFunction(r[2]),t};