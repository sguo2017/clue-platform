function go_tools_init(){if(0==$("#tools_main_diagram").length)return!1;var e=go.GraphObject.make;return goTools=new GoTools("tools_main_diagram"),goTools.goToolsFilesSystem=new GoToolsFilesSystem(goTools,{openWindowId:"openDocument",removeWindowId:"removeDocument",currentFileId:"currentFile",filesToRemoveListId:"filesToRemove",filesToOpenListId:"filesToOpen"}),goTools.goToolsUI=new GoToolsUI(goTools,"ui","goTools"),goTools.goToolsUI.setBehavior("dragging"),e(go.Overview,"tools_main_overview",{observed:goTools,contentAlignment:go.Spot.Center,maxScale:.5}),goTools.palette=new GoToolsPalette("tools_main_palette",goTools),document.isGoToolsInit=!0,!0}function bindDataEvents(){$("#btn-image-export").click(exportImage),$("#btn-data-save").click({selector:$("#btn-data-save")},exportToFile),$("#btn-data-import").click({selector:$("#field-data-import")},showFilePicker),$("#field-data-import").change({selector:$("#field-data-import")},importFromFile)}function exportImage(){var e=goTools.makeImageData({maxSize:new go.Size(Infinity,Infinity),scale:1});window.open(e)}function exportToFile(e){var o=goTools.model.toJson();e.data.selector.attr("href","data:text/txt;charset=utf-8,"+o)}function showFilePicker(e){e.data.selector.click()}function importFromFile(e){var o=e.data.selector.get(0).files;if(!(o.length<=0)){var t=o[0],n=new FileReader;n.readAsText(t,"utf-8"),n.onload=function(){try{goTools.layout=$$(go.ForceDirectedLayout),goTools.startTransaction("importData"),go.Model.fromJson(this.result,goTools.model),goTools.commitTransaction("importData"),goTools.layout=$$(go.Layout),highLightMainFunction()}catch(e){alert("\u6587\u4ef6\u5185\u5bb9\u9519\u8bef\uff01"),goTools.rollbackTransaction(),goTools.layout=$$(go.Layout)}}}}function dataUrlToBlob(e){for(var o=e.split(","),t=o[0].match(/:(.*?);/)[1],n=atob(o[1]),i=n.length,a=new Uint8Array(i);i--;)a[i]=n.charCodeAt(i);return new Blob([a],{type:t})}function saveAnalyseResult(e,o,t){$.ajax({url:"/call_analyse_savers",method:"POST",data:{call_analyse_saver:{data_url:e,image_url:o,title:t}}}).done(function(){alert("\u6210\u529f\u4fdd\u5b58\u6570\u636e\u5230\u670d\u52a1\u5668\uff01")}).error(function(){alert("\u4fdd\u5b58\u5931\u8d25")})}function saveDataToFastDFS(e){var o=new FormData,t=new Blob([goTools.model.toJson()],{type:"text/plain"}),n=goTools.makeImageData({size:new go.Size(160,120)}),i=dataUrlToBlob(n);o.append("data",t,"data.json"),o.append("image",i,"image.png"),fetch("http://123.56.157.233:9090/FastDFSWeb/servlet/imageUploadServlet",{method:"POST",mode:"cors",body:o}).then(function(e){return e.json()}).then(function(o){saveAnalyseResult(o.data,o.image,e)})["catch"](function(){alert("\u670d\u52a1\u5668\u8fde\u63a5\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01")})}function draw(e){if(e){var o=getQueryString("type"),t=getQueryString("sources");switch(o){case"calllist":drawCalllist(t)}}}function drawCalllist(e){var o=go.GraphObject.make;switch(goTools.setTemplate(o(go.Node,"Auto",{},o(go.Shape,"circle",{name:"OBJSHAPE",strokeWidth:4,stroke:"#7B7B7B"},new go.Binding("fill","fill"),new go.Binding("stroke","isHighlighted",function(e){return e?"red":"#7B7B7B"}).ofObject(),new go.Binding("strokeWidth","isHighlighted",function(e){return e?10:4}).ofObject()),o(go.TextBlock,"default text",{margin:2,stroke:"#181818",font:"bold 12pt serif",alignment:go.Spot.Center,verticalAlignment:go.Spot.Center},new go.Binding("text","key"))),o(go.Link,{layerName:"Background",selectable:!1},new go.Binding("visible","can_show"),new go.Binding("can_show","can_show"),o(go.Shape,{name:"OBJSHAPE",strokeWidth:4,stroke:"#7B7B7B"},new go.Binding("stroke","isHighlighted",function(e){return e?"red":"#7B7B7B"}).ofObject(),new go.Binding("strokeWidth","isHighlighted",function(e){return e?10:4}).ofObject()),o(go.TextBlock,{name:"TEXTBLOCK",stroke:"black",font:"bold 12pt serif",background:"lightblue"},new go.Binding("text","feq")))),e){case"excel":calllistDataPreparing.getDataFromLocal(),calllistDataPreparing.formatData(),force_directed();break;case"db":calllistDataPreparing.getDataFromServer(),calllistDataPreparing.formatData(),force_directed();break;default:force_directed()}}function force_directed(){goTools.layout=$$(go.ForceDirectedLayout),goTools.startTransaction("generateTree"),goTools.model.nodeDataArray=calllistDataPreparing.nodesArray,goTools.model.linkDataArray=makeLinksTwoDirections(calllistDataPreparing.linksArray),goTools.commitTransaction("generateTree"),goTools.layout=$$(go.Layout),setTimeout(function(){calllistDataPreparing.nodesArray.length<=0&&calllistDataPreparing.linksArray.length<=0&&alert("\u6ca1\u6709\u6570\u636e")},0)}function makeLinksTwoDirections(e){return e.concat(e.map(function(e){return{from:e.to,to:e.from,can_show:!1}}))}function bindHighLighEvents(){highLightMainFunction(),goTools.addDiagramListener("ChangedSelection",highLightMainFunction),$("#tab_diagram_operation :checkbox").change(highLightMainFunction)}function bindFeqEvents(){$("#btn-filter-feq").click(function(){var e=$("#fitler-method").val(),o=$("#fitler-type").val();frequencyFilter($("#filter-feq").val(),e,o)}),$("#btn-reset-feq").click(resetFilter),$(document).on("filter",highLightMainFunction)}function highLightMainFunction(){goTools.clearHighlighteds();var e=$("#check-diaplay-max").is(":checked"),o=$("#check-diaplay-connected").is(":checked"),t=$("#check-diaplay-between").is(":checked"),n=goTools.selection;if(e&&0===n.count)setFeqMax();else if(o&&1===n.count)setAllConnected(n);else if(t&&2===n.count){var i=n.toArray();setAllPaths(findAllPaths(i[0],i[1]))}}function setFeqMax(){var e={targets:[],value:-999};goTools.links.each(function(o){if(0!=o.can_show){var t=parseInt(o.findObject("TEXTBLOCK").text);o.visible&&t>e.value?(e.targets=[o],e.value=t):o.visible&&t==e.value&&e.targets.push(o)}}),e.targets.forEach(function(e){lightIt(e),lightIt(e.fromNode),lightIt(e.toNode)})}function setAllConnected(e){var o=e.first();o instanceof go.Node&&(lightIt(o),o.linksConnected.each(function(e){0!=e.can_show&&e.visible&&lightIt(e)}),o.findNodesConnected().each(function(e){var t=!1;o.findLinksBetween(e).each(function(e){if(0!=e.can_show&&e.visible)return void(t=!0)}),t&&lightIt(e)}))}function setAllPaths(e){function o(e){for(var o=!1,t=0;t<e.count-1;t++){var n=e.elt(t).findLinksBetween(e.elt(t+1)),i=!1;if(n.each(function(e){if(0!=e.can_show&&e.visible)return void(i=!0)}),!i){o=!0;break}}return o}e.each(function(e){if(!o(e)){for(var t=0;t<e.count-1;t++){lightIt(e.elt(t));e.elt(t).findLinksBetween(e.elt(t+1)).each(function(e){0!=e.can_show&&e.visible&&lightIt(e)})}lightIt(e.elt(e.count-1))}})}function findAllPaths(e,o){function t(e,o){e.findNodesOutOf().each(function(a){if(a!==e)if(a===o){var l=n.copy();l.add(o),i.add(l)}else n.contains(a)||(n.add(a),t(a,o),n.removeAt(n.count-1))})}var n=new go.List(go.Node),i=new go.List(go.List);return n.add(e),t(e,o),i}function lightIt(e){e.isHighlighted=!0}function frequencyFilter(e,o,t){switch(e=e.toString(),t){case"continuous":if(!e)return void resetFilter();goTools.links.each(function(t){if(0!=t.can_show){var n=t.findObject("TEXTBLOCK").text;t.visible=t.visible&&n.compareTo(e,o)}});break;case"renew":resetFilter(),goTools.links.each(function(t){if(0!=t.can_show){var n=t.findObject("TEXTBLOCK").text;t.visible=n.compareTo(e,o)}})}goTools.nodes.each(function(e){var o=!0;e.linksConnected.each(function(e){if(0!=e.can_show&&e.visible)return void(o=!1)}),o&&(e.visible=!1)}),$(document).trigger("filter")}function resetFilter(){goTools.nodes.each(function(e){e.visible=!0}),goTools.links.each(function(e){0!=e.can_show&&(e.visible=!0)}),$(document).trigger("filter")}$(document).on("turbolinks:load",function(){go_tools_init()}),$(document).on("turbolinks:load",function(){"undefined"!=typeof goTools&&bindDataEvents()}),$(document).on("turbolinks:load",function(){GoTools.prototype.setTemplate=function(e,o){e&&(this.nodeTemplate=e),o&&(this.linkTemplate=o)},draw("undefined"!=typeof goTools)}),$(document).on("turbolinks:load",function(){"undefined"!=typeof goTools&&(bindHighLighEvents(),bindFeqEvents())});