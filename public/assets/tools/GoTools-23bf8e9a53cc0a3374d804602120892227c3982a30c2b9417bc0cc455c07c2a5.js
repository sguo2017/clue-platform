function GoTools(e){go.Diagram.call(this,e),this._goToolsFilesSystem=null,this._goToolsUI=null,this._palettes=[],this._pointNodes=new go.Set(go.Node),this._dimensionLinks=new go.Set(go.Link),this._angleNodes=new go.Set(go.Node);var t=go.GraphObject.make;this.initialContentAlignment=go.Spot.Center,this.initialAutoScale=go.Diagram.UniformToFill,this.initialDocumentSpot=go.Spot.TopCenter,this.initialViewportSpot=go.Spot.TopCenter,this.allowDrop=!0,this.allowLink=!0,this.allowSelect=!0,this.undoManager.isEnabled=!0,this.layout.isOngoing=!1,this.model=t(go.GraphLinksModel,{modelData:{units:"centimeters",unitsAbbreviation:"cm",gridSize:10,wallWidth:5,preferences:{showWallGuidelines:!0,showWallLengths:!0,showWallAngles:!0,showOnlySmallWallAngles:!0,showGrid:!0,gridSnap:!0}}}),this.isReadOnly=!1,this.scrollMode=go.Diagram.DocumentScroll,this.resizingTool=new go.ResizingTool,this.resizingTool.isGridSnapEnabled=!0,this.draggingTool=new go.DraggingTool,this.draggingTool.isGridSnapEnabled=!0,this.draggingTool.gridSnapCellSpot=go.Spot.TopLeft,this.draggingTool.gridCellSize=this.model.modelData.gridSize,this.draggingTool.dragsTree=!0,this.rotatingTool=new go.RotatingTool,this.rotatingTool.snapAngleEpsilon=10,this.grid=t(go.Panel,"Grid",{gridCellSize:new go.Size(this.model.modelData.gridSize,this.model.modelData.gridSize),visible:!0},t(go.Shape,"LineH",{stroke:"lightgray"}),t(go.Shape,"LineV",{stroke:"lightgray"})),this.contextMenu=makeContextMenu(),this.commandHandler.canGroupSelection=!0,this.commandHandler.canUngroupSelection=!0,this.commandHandler.archetypeGroupData={isGroup:!0},this.commandHandler.copiesTree=!0,this.commandHandler.deletesTree=!0,this.addModelChangedListener(function(e){if(e.isTransactionFinished){var t=null,a=e.object;null!==a&&a.changes.each(function(a){"nodeDataArray"==a.modelChange?a.change===go.ChangedEvent.Insert?console.log(e.propertyName+" \u6dfb\u52a0\u4e86\u4e3b\u952e\u4e3a: "+a.newValue.key+" \u7684\u8282\u70b9"):a.change===go.ChangedEvent.Remove&&console.log(e.propertyName+" \u5220\u9664\u4e86\u4e3b\u952e\u4e3a: "+a.oldValue.key+" \u7684\u8282\u70b9"):"linkDataArray"==a.modelChange?a.change===go.ChangedEvent.Insert?console.log(e.propertyName+" \u6dfb\u52a0\u4e86\u8fde\u7ebf: "+a.newValue):a.change===go.ChangedEvent.Remove&&console.log(e.propertyName+" \u5220\u9664\u4e86\u8fde\u7ebf: "+a.oldValue):"linkFromKey"==a.modelChange?a.change===go.ChangedEvent.Property&&console.log(e.propertyName+" \u4fee\u6539\u4e86\u8fde\u7ebf: "+a.object+" \u7684\u8d77\u70b9\uff0c\u4ece: "+a.oldValue.key+" \u5230: "+a.newValue.key):"linkToKey"==a.modelChange&&a.change===go.ChangedEvent.Property&&console.log(e.propertyName+" \u4fee\u6539\u4e86\u8fde\u7ebf: "+a.object+" \u7684\u672b\u7aef\uff0c\u4ece: "+a.oldValue.key+" \u5230: "+a.newValue.key),a.diagram instanceof GoTools&&(t=a.diagram)}),t&&t.goToolsUI&&t.goToolsUI.updateStatistics()}}),this.addDiagramListener("Modified",function(e){var t=e.diagram;if(t.goToolsFilesSystem){var a=document.getElementById(t.goToolsFilesSystem.state.currentFileId);if(a){var o=a.textContent.indexOf("\uff08\u672a\u4fdd\u5b58\uff09");t.isModified?o<0&&(a.textContent=a.textContent+"\uff08\u672a\u4fdd\u5b58\uff09"):o>=0&&(a.textContent=a.textContent.substr(0,o))}}}),this.addDiagramListener("InitialLayoutCompleted",function(e){console.log("GoTools \u521d\u59cb\u5316\u5b8c\u6bd5");var t=e.diagram.model.nodeDataArray;if(t.length>0){var a=t[Math.floor(Math.random()*t.length)];e.diagram.findNodeForData(a)}}),this.addDiagramListener("ExternalObjectsDropped",function(e){if("PaletteWallNode"===e.diagram.selection.first().category){var t=e.diagram.selection.first(),a=getWallPartEndpoints(t),o={key:"wall",category:"WallGroup",caption:"Wall",startpoint:a[0],endpoint:a[1],strokeWidth:parseFloat(e.diagram.model.modelData.wallWidth),isGroup:!0,notes:""};e.diagram.model.addNodeData(o);var n=e.diagram.findPartForKey(o.key);e.diagram.updateWall(n),e.diagram.remove(t)}if(e.diagram.goToolsUI){var i=e.diagram.goToolsUI;e.diagram.toolManager.mouseDownTools.elt(0).isEnabled&&i.setBehavior("dragging",e.diagram)}}),this.addDiagramListener("ClipboardPasted",function(e){e.diagram.selection.iterator.each(function(t){"WallGroup"===t.category&&e.diagram.updateWall(t)})}),this.addDiagramListener("ChangedSelection",function(e){var t=e.diagram;t.skipsUndoManager=!0,t.startTransaction("remove dimension links and angle nodes"),t.pointNodes.iterator.each(function(t){e.diagram.remove(t)}),t.dimensionLinks.iterator.each(function(t){e.diagram.remove(t)});var a=[];t.links.iterator.each(function(e){e.data&&"DimensionLink"==e.data.category&&a.push(e)});for(var o=0;o<a.length;o++)e.diagram.remove(a[o]);if(t.pointNodes.clear(),t.dimensionLinks.clear(),t.angleNodes.iterator.each(function(t){e.diagram.remove(t)}),t.angleNodes.clear(),t.commitTransaction("remove dimension links and angle nodes"),t.skipsUndoManager=!1,t.updateWallDimensions(),t.updateWallAngles(),t.goToolsUI){var n=(t.goToolsUI,t.selection);t.selection.first();if(n.count>1){var i=!1;n.iterator.each(function(e){"WindowNode"!==e.category&&"DoorNode"!==e.category&&"WallGroup"!==e.category||(i=!0)})}}}),this.addDiagramListener("SelectionMoved",function(e){var t=e.diagram.findNodeForKey(0);if(t){var a=t.location.x;e.diagram.selection.each(function(e){if("mindmap"==e.category){var t=e.location.x;console.log("1"),a<t&&"right"!==e.data.dir?updateMindmapDirection(e,"right"):a>t&&"left"!==e.data.dir&&updateMindmapDirection(e,"left"),layoutMindMap(e)}})}}),this.brushes={wood:t(go.Brush,"Linear",{0:"#964514",1:"#5E2605"}),wall:t(go.Brush,"Linear",{0:"#A8A8A8",1:"#545454"}),blue:t(go.Brush,"Linear",{0:"#42C0FB",1:"#009ACD"}),metal:t(go.Brush,"Linear",{0:"#A8A8A8",1:"#474747"}),green:t(go.Brush,"Linear",{0:"#9CCB19",1:"#698B22"}),bluegrad:t(go.Brush,"Linear",{0:"rgb(150, 150, 250)",.5:"rgb(86, 86, 186)",1:"rgb(86, 86, 186)"}),greengrad:t(go.Brush,"Linear",{0:"rgb(158, 209, 159)",1:"rgb(67, 101, 56)"}),redgrad:t(go.Brush,"Linear",{0:"rgb(206, 106, 100)",1:"rgb(180, 56, 50)"}),yellowgrad:t(go.Brush,"Linear",{0:"rgb(254, 221, 50)",1:"rgb(254, 182, 50)"}),lightgrad:t(go.Brush,"Linear",{1:"#E6E6FA",0:"#FFFAF0"})},this.makeNodeTemplateMap(),this.makeGroupTemplateMap(),this.makeLinkTemplateMap(),jQuery("#dataInspector").length>0&&(this.dataInspector=new Inspector("dataInspector",this,{properties:{key:{readOnly:!0},comments:{}}})),jQuery("#debugInspector").length>0&&(this.debugInspector=new DebugInspector("debugInspector",this,{acceptButton:!0,resetButton:!0})),this.cxElement=document.getElementById("contextMenu");var a=this;this.cxcommand=function(e,t){switch(t===undefined&&(t=e.currentTarget.id),t){case"cut":a.commandHandler.cutSelection();break;case"copy":a.commandHandler.copySelection();break;case"paste":a.commandHandler.pasteSelection(a.lastInput.documentPoint);break;case"delete":a.commandHandler.deleteSelection();break;case"color":var o=window.getComputedStyle(document.elementFromPoint(e.clientX,e.clientY).parentElement)["background-color"];changeColor(a,o)}a.currentTool.stopTool()},this.cxElement.addEventListener("contextmenu",function(e){return e.preventDefault(),!1},!1),this.contextMenu=t(go.HTMLInfo,{show:function(e,t){t.commandHandler;t.cxElement.style.display="block";var a=t.lastInput.viewPoint;t.cxElement.style.left=a.x+"px",t.cxElement.style.top=a.y+38+"px"},mainElement:this.cxElement}),$(".tools_search").draggable({handle:"#pushpin"});var o=new WallBuildingTool;this.toolManager.mouseDownTools.insertAt(0,o);var n=new WallReshapingTool;this.toolManager.mouseDownTools.insertAt(3,n),this.toolManager.draggingTool.doMouseUp=function(){go.DraggingTool.prototype.doMouseUp.call(this),this.diagram.updateWallAngles(),this.diagram.model.modelData.preferences&&(this.isGridSnapEnabled=this.diagram.model.modelData.preferences.gridSnap)},this.toolManager.draggingTool.doMouseMove=function(){this.diagram.lastInput.shift?this.isGridSnapEnabled=!1:this.diagram.model.modelData.preferences&&(this.isGridSnapEnabled=this.diagram.model.modelData.preferences.gridSnap),go.DraggingTool.prototype.doMouseMove.call(this),this.isActive},this.toolManager.resizingTool.doMouseMove=function(){this.adornedObject;this.diagram.updateWallDimensions(),go.ResizingTool.prototype.doMouseMove.call(this)},this.toolManager.resizingTool.computeMaxSize=function(){var e=this,t=e.adornedObject.part,a=this.diagram.findPartForKey(t.data.group);if(("DoorNode"===t.category||"WindowNode"===t.category)&&null!==a){var o,n,i=null;t.adornments.iterator.each(function(e){"WallPartResizeAdornment"===e.name&&(i=e)}),i.elements.iterator.each(function(t){t instanceof go.Shape&&t.alignment===e.handle.alignment&&(n=t.getDocumentPoint(go.Spot.Center)),t instanceof go.Shape&&t.alignment!==e.handle.alignment&&(o=t.getDocumentPoint(go.Spot.Center))});var r,d=Number.MAX_VALUE;a.memberParts.iterator.each(function(e){if(e.data.key!==t.data.key)for(var a=getWallPartEndpoints(e),i=0;i<a.length;i++){var l=a[i],s=Math.sqrt(l.distanceSquaredPoint(n));if(s<d){var g=Math.sqrt(l.distanceSquaredPoint(o));g>s&&(d=s,r=l)}}}),r!==undefined&&null!==r||(r=a.data.startpoint.distanceSquaredPoint(n)>a.data.startpoint.distanceSquaredPoint(o)?a.data.endpoint:a.data.startpoint);var l=Math.sqrt(o.distanceSquaredPoint(r));return new go.Size(l,a.data.strokeWidth)}return go.ResizingTool.prototype.computeMaxSize.call(e)},this.toolManager.draggingTool.isGridSnapEnabled=!0,this.toolManager.clickCreatingTool.archetypeNodeData={text:"new node"}}function getAdjustedPoint(e,t,a,o){var n=e.copy();return e.offset(0,-.5*t.data.strokeWidth-o),e.offset(-n.x,-n.y).rotate(a).offset(n.x,n.y),e}function buildDimensionLink(e,t,a,o,n,i,r,d){go.GraphObject.make;a=getAdjustedPoint(a,e,n,i),o=getAdjustedPoint(o,e,n,i);var l={key:e.data.key+"PointNode"+t,category:"PointNode",loc:go.Point.stringify(a)},s={key:e.data.key+"PointNode"+(t+1),category:"PointNode",loc:go.Point.stringify(o)},g={key:e.data.key+"DimensionLink",category:"DimensionLink",from:l.key,to:s.key,stroke:"gray",angle:n,wall:e.data.key,soloWallFlag:r},c=$$(go.Node,"Position",new go.Binding("location","loc",go.Point.parse).makeTwoWay(go.Point.stringify)),u=$$(go.Node,"Position",new go.Binding("location","loc",go.Point.parse).makeTwoWay(go.Point.stringify)),p=$$(go.Link,{locationSpot:go.Spot.TopLeft},$$(go.Shape,{stroke:"gray",strokeWidth:2,name:"SHAPE"}),$$(go.Shape,{toArrow:"OpenTriangle",stroke:"gray",strokeWidth:2}),$$(go.Shape,{fromArrow:"BackwardOpenTriangle",stroke:"gray",strokeWidth:2}),$$(go.TextBlock,{text:"sometext",segmentOffset:new go.Point(0,-10),font:"13px sans-serif"},new go.Binding("text","",function(e){var t=e.diagram;if(t){var a=null,o=null;if(t.pointNodes.iterator.each(function(t){t.data.key===e.data.from&&(a=t),t.data.key===e.data.to&&(o=t)}),null!==a){var n=a.location,i=o.location;return t.convertPixelsToUnits(Math.sqrt(n.distanceSquaredPoint(i))).toFixed(2)+t.model.modelData.unitsAbbreviation}return null}return null}).ofObject(),new go.Binding("angle","angle",function(e){return e>90&&e<270?(e+180)%360:e}),new go.Binding("segmentOffset","angle",function(e,t){var a=t.part.diagram;if(a){var o=a.findPartForKey(t.part.data.wall);return o.rotateObject.angle>135&&o.rotateObject.angle<315?new go.Point(0,10):new go.Point(0,-10)}return new go.Point(0,0)}).ofObject(),new go.Binding("font","",function(e){var t=e.diagram,a=null,o=null;if(t.pointNodes.iterator.each(function(t){t.data.key===e.data.from&&(a=t),t.data.key===e.data.to&&(o=t)}),null!==a){var n=a.location,i=o.location,r=Math.sqrt(n.distanceSquaredPoint(i));return r>40?"13px sans-serif":r<=40&&r>=20?"11px sans-serif":"9px sans-serif"}return"13px sans-serif"}).ofObject()));d.pointNodes.add(c),d.pointNodes.add(u),d.dimensionLinks.add(p),d.add(c),d.add(u),d.add(p),c.data=l,u.data=s,p.data=g,p.fromNode=c,p.toNode=u}go.Diagram.inherit(GoTools,go.Diagram),Object.defineProperty(GoTools.prototype,"goToolsFilesSystem",{get:function(){return this._goToolsFilesSystem},set:function(e){e instanceof GoToolsFilesSystem?this._goToolsFilesSystem=e:this._goToolsFilesSystem=null}}),Object.defineProperty(GoTools.prototype,"goToolsUI",{get:function(){return this._goToolsUI},set:function(e){e instanceof GoToolsUI?this._goToolsUI=e:this._goToolsUI=null}}),Object.defineProperty(GoTools.prototype,"palettes",{get:function(){return this._palettes}}),Object.defineProperty(GoTools.prototype,"pointNodes",{get:function(){return this._pointNodes},set:function(e){this._pointNodes=e}}),Object.defineProperty(GoTools.prototype,"dimensionLinks",{get:function(){return this._dimensionLinks},set:function(){this._dimensionLinks=val}}),Object.defineProperty(GoTools.prototype,"angleNodes",{get:function(){return this._angleNodes},set:function(){this._angleNodes=val}}),GoTools.prototype.convertPixelsToUnits=function(e){var t=this.model.modelData.units;return"meters"===t?e/100*2:"feet"===t?e/30.48*2:"inches"===t?e/2.54*2:2*e},GoTools.prototype.convertUnitsToPixels=function(e){var t=this.model.modelData.units;return"meters"===t?100*e/2:"feet"===t?30.48*e/2:"inches"===t?2.54*e/2:e/2},GoTools.prototype.updateWall=function(e){var t=e.findObject("SHAPE"),a=new go.Geometry(go.Geometry.Line),o=e.data.startpoint,n=e.data.endpoint,i=new go.Point((o.x+n.x)/2,(o.y+n.y)/2);a.startX=0,a.startY=0,a.endX=Math.sqrt(o.distanceSquaredPoint(n)),a.endY=0,t.geometry=a,e.location=i;var r=o.directionPoint(n);e.rotateObject.angle=r,this.updateWallDimensions()},GoTools.prototype.updateWallDimensions=function(){var e=this;if(e.skipsUndoManager=!0,e.startTransaction("update wall dimensions"),e.model.modelData.preferences&&!e.model.modelData.preferences.showWallLengths)return e.pointNodes.iterator.each(function(t){e.remove(t)}),e.dimensionLinks.iterator.each(function(t){e.remove(t)}),e.pointNodes.clear(),e.dimensionLinks.clear(),e.commitTransaction("update wall dimensions"),void(e.skipsUndoManager=!1);e.dimensionLinks.iterator.each(function(e){e.visible=!0});var t=e.selection,a=new go.Set(go.Group);t.iterator.each(function(t){if("WindowNode"!==t.category&&"DoorNode"!==t.category||null===t.containingGroup||a.add(t.containingGroup),"WallGroup"===t.category&&null!==t.data){var o=null;if(e.dimensionLinks.iterator.each(function(e){e.data.soloWallFlag&&e.data.wall===t.data.key&&(o=e)}),null!==o){var n=null,i=null;e.pointNodes.iterator.each(function(e){e.data.key===t.data.key+"PointNode1"&&(n=e),e.data.key===t.data.key+"PointNode2"&&(i=e)});var r=t.data.startpoint,d=t.data.endpoint,l=r.x+r.y<=d.x+d.y?r:d,s=r.x+r.y>d.x+d.y?r:d,g=getAdjustedPoint(l.copy(),t,t.rotateObject.angle,10),c=getAdjustedPoint(s.copy(),t,t.rotateObject.angle,10);n.data.loc=go.Point.stringify(g),i.data.loc=go.Point.stringify(c),o.data.angle=t.rotateObject.angle,n.updateTargetBindings(),i.updateTargetBindings(),o.updateTargetBindings()}else{var r=t.data.startpoint,d=t.data.endpoint,l=r.x+r.y<=d.x+d.y?r:d,s=r.x+r.y>d.x+d.y?r:d;buildDimensionLink(t,1,l.copy(),s.copy(),t.rotateObject.angle,10,!0,e)}}}),a.iterator.each(function(t){var a=t.data.startpoint,o=t.data.endpoint,n=a.x+a.y<=o.x+o.y?a:o,i=a.x+a.y>o.x+o.y?a:o,r=[];t.memberParts.iterator.each(function(e){if(e.isSelected){var t=getWallPartEndpoints(e);r.push(t[0]),r.push(t[1])}}),r.sort(function(e,t){return e.x+e.y>t.x+t.y?1:e.x+e.y<t.x+t.y?-1:0}),r.unshift(n),r.push(i);for(var d=t.rotateObject.angle,l=1,s=0;s<r.length-1;s++){var g=null;if(m=null,e.pointNodes.iterator.each(function(e){e.data.key===t.data.key+"PointNode"+l&&(g=e),e.data.key===t.data.key+"PointNode"+(l+1)&&(m=e)}),null!==g){var c=getAdjustedPoint(r[s].copy(),t,d,5),u=getAdjustedPoint(r[s+1].copy(),t,d,5);g.data.loc=go.Point.stringify(c),m.data.loc=go.Point.stringify(u),g.updateTargetBindings(),m.updateTargetBindings()}else buildDimensionLink(t,l,r[s].copy(),r[s+1].copy(),d,5,!1,e);l+=2}var p=null;if(e.dimensionLinks.iterator.each(function(e){e.fromNode.data.key===t.data.key+"PointNode"+l&&e.toNode.data.key===t.data.key+"PointNode"+(l+1)&&(p=e)}),null!==p){var g=null,m=null;e.pointNodes.iterator.each(function(e){e.data.key===t.data.key+"PointNode"+l&&(g=e),e.data.key===t.data.key+"PointNode"+(l+1)&&(m=e)});var c=getAdjustedPoint(r[0].copy(),t,d,25),u=getAdjustedPoint(r[r.length-1].copy(),t,d,25);g.data.loc=go.Point.stringify(c),m.data.loc=go.Point.stringify(u),g.updateTargetBindings(),m.updateTargetBindings()}else buildDimensionLink(t,l,r[0].copy(),r[r.length-1].copy(),d,25,!1,e)}),e.dimensionLinks.iterator.each(function(t){var a=!1;if(e.pointNodes.iterator.each(function(e){e.data.key==t.data.to&&(a=!0)}),a){Math.sqrt(t.toNode.location.distanceSquaredPoint(t.fromNode.location))<1&&!t.data.soloWallFlag&&(t.visible=!1)}else e.remove(t)}),e.commitTransaction("update wall dimensions"),e.skipsUndoManager=!1};var getWallsIntersection=function(e,t){if(null===e||null===t)return null;var a=e.data.endpoint.y-e.data.startpoint.y,o=e.data.startpoint.x-e.data.endpoint.x,n=a*e.data.startpoint.x+o*e.data.startpoint.y,i=t.data.endpoint.y-t.data.startpoint.y,r=t.data.startpoint.x-t.data.endpoint.x,d=i*t.data.startpoint.x+r*t.data.startpoint.y,l=a*r-i*o,s=null,g=null;if(0===l)return e.data.startpoint.equals(t.data.startpoint)||e.data.startpoint.equals(t.data.endpoint)?e.data.startpoint:e.data.endpoint.equals(t.data.startpoint)||e.data.endpoint.equals(t.data.endpoint)?e.data.endpoint:null;s=(r*n-o*d)/l,g=(a*d-i*n)/l;var c=Math.min(e.data.startpoint.x,e.data.endpoint.x)<=s&&Math.max(e.data.startpoint.x,e.data.endpoint.x)>=s&&Math.min(e.data.startpoint.y,e.data.endpoint.y)<=g&&Math.max(e.data.startpoint.y,e.data.endpoint.y)>=g,u=Math.min(t.data.startpoint.x,t.data.endpoint.x)<=s&&Math.max(t.data.startpoint.x,t.data.endpoint.x)>=s&&Math.min(t.data.startpoint.y,t.data.endpoint.y)<=g&&Math.max(t.data.startpoint.y,t.data.endpoint.y)>=g;return c&&u?new go.Point(s,g):null};GoTools.prototype.updateWallAngles=function(){var e=this;if(e.skipsUndoManager=!0,e.startTransaction("display angles"),e.model.modelData.preferences&&e.model.modelData.preferences.showWallAngles){e.angleNodes.iterator.each(function(e){e.visible=!0});var t=[];e.selection.iterator.each(function(e){"WallGroup"===e.category&&t.push(e)});for(var a=0;a<t.length;a++){var o=new go.Set("string"),n=t[a];e.findNodesByExample({category:"WallGroup"}).iterator.each(function(t){if(null!==t.data&&null!==n.data&&!o.contains(t.data.key)&&t.data.key!==n.data.key&&null!==getWallsIntersection(n,t)&&!o.contains(t.data.key)){o.add(t.data.key);var a=getWallsIntersection(n,t),i=e.findObjectsNear(a,1,function(e){if(null!==e.part)return e.part},function(e){return"WallGroup"===e.category},!1),r=[];i.iterator.each(function(t){var o=e.model.modelData.gridSize>=10?e.model.modelData.gridSize:10;Math.sqrt(t.data.startpoint.distanceSquaredPoint(a))>o&&r.push({point:t.data.startpoint,wall:t.data.key}),Math.sqrt(t.data.endpoint.distanceSquaredPoint(a))>o&&r.push({point:t.data.endpoint,wall:t.data.key})});for(var d=30,l=0;l<r.length;l++){var s=Math.sqrt(r[l].point.distanceSquaredPoint(a));s<d&&(d=s)}r.sort(function(e,t){if(e=e.point,t=t.point,e.x-a.x>=0&&t.x-a.x<0)return!0;if(e.x-a.x<0&&t.x-a.x>=0)return!1;if(e.x-a.x==0&&t.x-a.x==0)return e.y-a.y>=0||t.y-a.y>=0?e.y>t.y:t.y>e.y;var o=(e.x-a.x)*(t.y-a.y)-(t.x-a.x)*(e.y-a.y);return o<0||!(o>0)&&(e.x-a.x)*(e.x-a.x)+(e.y-a.y)*(e.y-a.y)>(t.x-a.x)*(t.x-a.x)+(t.y-a.y)*(t.y-a.y)});for(var l=0;l<r.length;l++){var g=r[l];if(null!=r[l+1])var c=r[l+1];else var c=r[0];var u=a.directionPoint(g.point),p=a.directionPoint(c.point),m=Math.abs(p-u+360)%360,h=u,y=[];i.iterator.each(function(e){y.push(e)}),y.sort(function(e,t){var a=e.data.key.match(/\d+/g),o=t.data.key.match(/\d+/g);return!!isNaN(a)||!isNaN(o)&&a>o});for(var f="",k=0;k<y.length;k++)f+=y[k].data.key;f+="angle"+l;var v=null;if(e.angleNodes.iterator.each(function(e){e.data.key===f&&(v=e)}),null!==v)v.data.angle=h,v.data.sweep=m,v.data.loc=go.Point.stringify(a),v.data.maxRadius=d,v.updateTargetBindings();else{var x={key:f,category:"AngleNode",loc:go.Point.stringify(a),stroke:"dodgerblue",angle:h,sweep:m,maxRadius:d},w=$$(go.Node,"Spot",{locationSpot:go.Spot.Center,locationObjectName:"SHAPE",selectionAdorned:!1},new go.Binding("location","loc",go.Point.parse).makeTwoWay(go.Point.stringify),$$(go.Shape,"Circle",{name:"SHAPE",fill:"red",height:0,width:0}),$$(go.Shape,{stroke:"green",strokeWidth:1.5,fill:null},new go.Binding("geometry","",function(e){var t=e.data.angle,a=e.data.sweep,o=Math.min(30,e.data.maxRadius);if("number"==typeof a&&a>0){var n=new go.Point(o,0).rotate(t);return(new go.Geometry).add(new go.PathFigure(n.x+o,n.y+o).add(new go.PathSegment(go.PathSegment.Arc,t,a,o,o,o,o))).add(new go.PathFigure(0,0)).add(new go.PathFigure(2*o,2*o))}return(new go.Geometry).add(new go.PathFigure(0,0)).add(new go.PathFigure(2*o,2*o))}).ofObject(),new go.Binding("stroke","sweep",function(e){return e%45<1||e%45>44?"dodgerblue":"lightblue"})),$$(go.Panel,"Auto",{name:"ARCLABEL"},new go.Binding("alignment","sweep",function(e,t){var a=Math.min(30,t.part.data.maxRadius),o=t.part.data.angle,n=new go.Point(a,0).rotate(o+e/2);return new go.Spot(.5,.5,n.x,n.y)}),$$(go.Shape,{stroke:"black",fill:"white"},new go.Binding("stroke","sweep",function(e){return e%45<1||e%45>44?"dodgerblue":"lightblue"})),$$(go.TextBlock,{font:"7pt sans-serif",margin:new go.Margin(2,2,2,2)},new go.Binding("text","sweep",function(e){return e.toFixed(2)+String.fromCharCode(176)}),new go.Binding("stroke","color"))));w.data=x,e.add(w),w.updateTargetBindings(),e.angleNodes.add(w)}}}})}var i=[];e.angleNodes.iterator.each(function(t){for(var a=t.data.key.match(/\d+/g),o=(t.data.key.match(/wall/g)||[]).length,n=[],r=0;r<a.length-1;r++)n.push("wall"+a[r]);o!==a.length-1&&n.push("wall");for(var r=0;r<n.length-1;r++){var d=e.findPartForKey(n[r]),l=e.findPartForKey(n[r+1]);null===getWallsIntersection(d,l)&&i.push(t)}var s=new go.Set(go.Node),g=t.data.key.slice(0,t.data.key.indexOf("angle"));e.angleNodes.iterator.each(function(e){e.data.key.includes(g)&&s.add(e)}),s.iterator.each(function(e){e.data.loc!==t.data.loc&&i.push(e)}),0===t.data.sweep&&i.push(t)});for(var a=0;a<i.length;a++)e.remove(i[a]),e.angleNodes.remove(i[a])}e.model.modelData.preferences&&e.model.modelData.preferences.showOnlySmallWallAngles&&e.angleNodes.iterator.each(function(e){e.data.sweep>=180&&(e.visible=!1)}),e.model.modelData.preferences&&!e.model.modelData.preferences.showWallAngles&&e.angleNodes.iterator.each(function(e){e.visible=!1}),e.commitTransaction("display angles"),e.skipsUndoManager=!1};